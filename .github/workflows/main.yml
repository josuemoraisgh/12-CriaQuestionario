name: windows-build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag (ex.: v1.2.3). Se vazio, será gerada automaticamente.'
        required: false
        default: ''
      tag_prefix:
        description: 'Prefixo do tag quando for gerado automaticamente'
        required: false
        default: 'v'
      prerelease:
        description: 'Marcar release como pré-release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      APP_NAME: LearnForge
      ENTRYPOINT: main.py
      PYTHON_VERSION: '3.12'
      DIST_DIR: dist
      BUILD_DIR: build
      TEX_OUTDIR: tex
      # pastas empacotadas (SRC;DEST) — uma por linha
      ADD_DATA_DIRS: >
        assets;assets
        beamer;beamer
        core;core
        editor;editor
        testgen;testgen

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (Py + PyInstaller)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller==6.10.0

      - name: Compute version/tag
        id: ver
        shell: pwsh
        run: |
          $ref = "${{ github.ref }}"
          $refName = "${{ github.ref_name }}"
          $dispatchTag = "${{ github.event.inputs.tag }}"
          $prefix = "${{ github.event.inputs.tag_prefix }}"
          if (-not $prefix) { $prefix = "v" }

          if ($ref -like "refs/tags/*") {
            $tag = $refName
          } elseif ($dispatchTag) {
            $tag = $dispatchTag
          } else {
            $stamp = (Get-Date -Format "yyyy.MM.dd.HHmm")
            $tag = "$prefix$stamp"
          }

          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$tag" >> $env:GITHUB_OUTPUT

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          $name = "${{ env.APP_NAME }}"
          $entry = "${{ env.ENTRYPOINT }}"
          $datas = @()
          "${{ env.ADD_DATA_DIRS }}".Split("`n") | ForEach-Object {
            $line = $_.Trim()
            if ($line) { $datas += "--add-data `"$line`"" }
          }
          $hidden = @(
            "--hidden-import lxml._elementpath",
            "--hidden-import docx.opc.constants",
            "--hidden-import docx.oxml",
            "--hidden-import docx.oxml.ns",
            "--hidden-import docx.oxml.parser"
          )
          pyinstaller --noconfirm --clean `
            --name "$name" `
            --onefile `
            --windowed `
            $hidden `
            $datas `
            "$entry"

      # ---------- MiKTeX Portable (pdflatex embutido) ----------
      - name: Install Chocolatey (for MiKTeX Portable)
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Install MiKTeX Portable
        shell: pwsh
        run: |
          choco install miktex.portable --yes --no-progress
          $mikRoot = (Get-ChildItem 'C:\ProgramData\chocolatey\lib\miktex.portable\tools' -Directory | Select-Object -First 1).FullName
          echo "MIK_ROOT=$mikRoot" >> $env:GITHUB_ENV

      - name: Preinstall LaTeX packages (beamer stack)
        shell: pwsh
        run: |
          $mikRoot = "${{ env.MIK_ROOT }}"
          if (-not (Test-Path $mikRoot)) { throw "MiKTeX portable not found." }

          # Ajuste de bin path (x64 em runners atuais)
          $bin = Join-Path $mikRoot 'miktex\bin'
          $bin64 = Join-Path $mikRoot 'miktex\bin\x64'
          if (Test-Path $bin64) { $bin = $bin64 }

          $mpm = Join-Path $bin 'mpm.exe'
          $pkgs = @(
            'beamer',
            'amsmath','amsfonts','amsthm',
            'bookmark','hyperref',
            'graphics','graphicx','xcolor',
            'enumitem','newunicodechar',
            'translator',
            'geometry',
            'epstopdf-pkg',
            'sansmathaccent',
            'koma-script'
          )
          & $mpm --verbose --update-db
          foreach ($p in $pkgs) {
            & $mpm --verbose --install=$p
          }

          # Teste: compila um arquivo mínimo para garantir pdflatex ok
          $tmp = Join-Path $env:RUNNER_TEMP 'min.tex'
          @"
\documentclass{beamer}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{amsmath,amssymb}
\usepackage{enumitem}
\usepackage{newunicodechar}
\begin{document}\begin{frame}Hello, pdflatex!\end{frame}\end{document}
"@ | Out-File -FilePath $tmp -Encoding utf8

          $pdflatex = Join-Path $bin 'pdflatex.exe'
          & $pdflatex -interaction=nonstopmode -halt-on-error $tmp

          echo "MIK_BIN=$bin" >> $env:GITHUB_ENV

      - name: Prepare bundle (EXE + portable TeX)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bundle | Out-Null
          Copy-Item -Path (Join-Path "${{ env.DIST_DIR }}" "${{ env.APP_NAME }}.exe") -Destination bundle/
          # Copia MiKTeX Portable para bundle/tex
          Copy-Item -Recurse -Force -Path "${{ env.MIK_ROOT }}" -Destination (Join-Path 'bundle' '${{ env.TEX_OUTDIR }}')

      - name: Create ZIP
        shell: pwsh
        run: |
          $zipName = "${{ env.APP_NAME }}-${{ steps.ver.outputs.version }}-win64.zip"
          Compress-Archive -Path bundle\* -DestinationPath $zipName
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Move-Item $zipName artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows-${{ steps.ver.outputs.version }}
          path: artifacts/*.zip
          if-no-files-found: error
          retention-days: 14

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ env.APP_NAME }} ${{ steps.ver.outputs.version }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.prerelease == 'true' }}
          files: artifacts/*.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
